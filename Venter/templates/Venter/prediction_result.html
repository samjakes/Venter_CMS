{% extends 'Venter/base.html' %}
{% block title %}Prediction Results{% endblock %}
{% block content %}
<link rel="stylesheet" href="../../static/assets/css/prediction_result.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
<link src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js">
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript" src="../../static/assets/js/download.js"></script>

  

<script>
    $(document).ready(function () {
      $('.nav-tabs > li').click(function(event){
        $('.nav-tabs > li.active').find("a").attr("style", "background-color: rgb(255,255,255) !important; color: rgb(0,0,0) !important");
        $('.nav-tabs li').removeClass('active');
        $(this).addClass('active');
        $(this).find("a").attr("style", "background-color: rgb(0,0,255) !important; color: rgb(255,255,255) !important");
        // console.log($(this).find("a").attr("href"));
        var domain_name = $(this).find("a").attr("href");
        drawStuff(domain_name);
      });

      $('.nav-pills > li').on('shown.bs.tab', function(){
        var h = $('.nav-pills .active > a').attr('href');
        console.log(h);
      });

      $("#graph").tab('show');

      // $("#graph").on('show.bs.tab', function(e) {
      //   console.log('graph tab to be shown');
      //   var d = $('.nav-tabs .active > a').attr('href');
      //   console.log("just checking if active domain:", d);
      // });

      // $("#cardview").on('shown.bs.tab', function(e) {
      //   console.log('graph tab is shown');
      //   var d = $('.nav-tabs .active > a').attr('href');
      //   console.log("just checking if active domain:", d);
      // });

      // $("#cardview").on('show.bs.tab', function(e) {
      //   console.log('cardview tab to be shown');
      //   var d = $('.nav-tabs .active > a').attr('href');
      //   console.log("just checking if active domain:", d);
      // });


      // $("#cardview").on('shown.bs.tab', function(e) {
      //   console.log('cardview tab is shown');
      //   var d = $('.nav-tabs .active > a').attr('href');
      //   console.log("just checking if active domain:", d);
      //   var main_dict = jQuery.parseJSON('{{dict_data|escapejs}}');
      //   var domain_name = 'Traffic';
      //   var stats = main_dict[domain_name];
      //   for(var key in stats){
      //     if(key == 'Statistics'){
      //       continue;
      //     }
      //     else{
      //       var response_arr=stats[key];
      //       if(key == 'Novel')
      //       {
      //         console.log("NOVEL CATEGORY");
      //         var count = 1;
      //         for(var sub in response_arr){
      //           console.log("sub category "+ count);
      //           for(var response in response_arr[sub]){
      //             console.log(response_arr[sub][response]);
      //           }
      //           count++;
      //         }
      //       }
      //       else
      //       {
      //         continue;
      //         console.log("Card Category:", key);
      //         for (var j = 0; j < response_arr.length; j++){
      //           console.log("response: ",response_arr[j]['response']);
      //           console.log("score: ",response_arr[j]['score']);
      //         }
      //       }  
      //     }
      //   }
      // });


      $("#chart-download-container").hide();
   
      $(".response_list").each(function(){
        $(this).children().each(function(){
           let list_index = $(this);
           let span_text = $(this).children().text();
           span_text = span_text.slice(0,-1);
           let score = parseInt(span_text);
           colorcode(score, list_index);
        })          
      })
      function colorcode(score, li_index){
        if(score > 90){
          li_index.attr("style", "background-color: rgb(0,255,0) !important");
        }
        else if(score > 80){
          li_index.attr("style", "background-color: rgb(15,255,0) !important");
        }
        else if(score > 70){
          li_index.attr("style", "background-color: rgb(75,255,0) !important");
        }
        else if(score > 60){
          li_index.attr("style", "background-color: rgb(135,255,0) !important");
        }
        else if(score > 50){
          li_index.attr("style", "background-color: rgb(195,255,0) !important");
        }
        else if(score > 40){
         li_index.attr("style", "background-color: rgb(255,255,0) !important");
        }
        else if(score > 30){
          li_index.attr("style", "background-color: rgb(255,240,0) !important");
        }
        else if(score > 20){
          li_index.attr("style", "background-color: rgb(255,180,0) !important");
        }
        else if(score > 10){
          li_index.attr("style", "background-color: rgb(255,120,0) !important");
        }
        else{
          li_index.attr("style", "background-color: rgb(255,60,0) !important");
        }
      }
  });
  </script>
  
  <script>
    function rndColor() {
      var r = ('0' + Math.floor(Math.random() * 256).toString(16)).substr(-2), // red
        g = ('0' + Math.floor(Math.random() * 256).toString(16)).substr(-2), // green
        b = ('0' + Math.floor(Math.random() * 256).toString(16)).substr(-2); // blue
      return '#' + r + g + b;
    }
    google.charts.load('current', { 'packages': ['corechart'] });
    google.charts.setOnLoadCallback(drawStuff);
    function drawStuff(domain_name) {
      if (!domain_name) {
        var domain_name = $('.nav-tabs .active > a').attr('href');
      }
      var main_dict = jQuery.parseJSON('{{dict_data|escapejs}}');
      var stats = main_dict[domain_name]['Statistics'];
      stats = jQuery.parseJSON(stats);
      
      noOfNovelCats = stats[stats.length - 1].length - 2
      colorseries = {}
      for (i = 0; i < noOfNovelCats; i++) {
        colorseries[i] = rndColor()
      }
      var data = new google.visualization.arrayToDataTable(stats);
      var options = {
        width: '1100',
        height: '600',
        isStacked: true,
        legend: {
          position: 'none'
        },
        title: domain_name,
        titleTextStyle: {
          fontName: 'Times New Roman',
          fontSize: 30,
          bold: true,
          italic: false,
          color: '#000099',
        },
        titlePosition: 'out',
        hAxis: {
          title: 'Category',
          titleTextStyle: {
            'fontSize': 23,
            color: 'black',
            bold: true,
            italic: false,
          },
          'textStyle': {
            'fontSize': 15,
            color: 'black',
          },
          gridlines: 3,
          slantedText: true,
          slantedTextAngle: 45,
        },
        vAxis: {
          title: 'Number of responses',
          titleTextStyle: {
            'fontSize': 23,
            color: 'black',
            bold: true,
            italic: false,
          },
          'textStyle': {
            'fontSize': 15,
            color: 'black',
            bold: true,
          },
        },
        bar: {
          groupWidth: "90%"
        },
        series: colorseries,
        is3D: true,
      };
      var chart_div = document.getElementById('chart_div');
      var chart = new google.visualization.ColumnChart(chart_div);
     
      function selectHandler() {
            var selectedItem = chart.getSelection()[0];
            if (selectedItem) {
              var category = data.getValue(selectedItem.row, 0);
              $('#graph').hide();
              $('#cardview').tab('show');
              document.getElementById(category).scrollIntoView();
            } 
          }
      google.visualization.events.addListener(chart, 'select', selectHandler);    
      google.visualization.events.addListener(chart, 'ready', function () {
          var imgUri = chart.getImageURI();
          $('#download_graph-btn').click(function() {
            download(imgUri, "chart.png", "image/png");
          });
      });
      chart.draw(data, options);
      $("#chart-download-container").show();
    };
  </script>
  
  
  <div class="outer-pr row">
    <div class="content-domain">
      <ul class="nav nav-tabs nav-fill" id="domain_tab" role="tablist">
        {% for domain in domain_list %}
            {% if domain == domain_list.0 %}
              <li class="nav-item active">
                  <a href="{{domain}}" class="nav-link" data-target="#graph" data-toggle="tab" role="tab">
                      {{domain}}
                  </a>
              </li>
            {% else %}
              <li class="nav-item">
                  <a href="{{domain}}" class="nav-link" data-target="#graph" data-toggle="tab" role="tab">
                      {{domain}}
                  </a>
              </li>
            {% endif %}
        {% endfor %}
      </ul>
    </div>
  
    <div class="content-navigator">
      <ul class="nav nav-pills justify-content-center" id="navigator_tab" role="tablist">
        <li class="nav-item active" id="pill-graph">
          <a class="nav-link" data-toggle="pill" href="#graph">
            Graph &nbsp; <i class="fa fa-area-chart chart-fa"></i>
          </a>
        </li>
        <li class="nav-item" id="pill-cardview">
          <a class="nav-link" data-toggle="pill" href="#cardview">
            CardView &nbsp; <i class="fa fa-list-alt list-fa"></i>
          </a>
        </li>
      </ul>
    </div>
  
    <div class="tab-content">
      <div id="cardview" class="tab-pane fade content-cardview">
        <div class="card-container" id="card-container">
          {% for category,response in domain_data.items %}
            {% if category == 'Statistics' %}
              <!--continue-->
            {% else %}
              <div class="card" id="{{category}}">
                <div class="card-header">
                  <label class="label-category">{{category}}</label>
                  <hr>
                </div>
                <div class="card-body">
                  <div class="card-text">
                    {% if not response %}
                        <li class="list-group-item">No response</li>
                    {% else %}
                      {% if category == 'Novel' %}
                        <ul class="list-group no_response_list">
                            {% for keys, item in response.items %}
                                <li class="list-group-item">
                                  <b>Sub category {{forloop.counter}}</b>
                                </li>
                                {% for r in item %}
                                    <li class="list-group-item">
                                      {{r}}
                                    </li>
                                {% endfor %}
                            {% endfor %}
                        </ul>    
                      {% else %}
                        <ul class="list-group response_list">
                            {% for r in response %}
                                <li class="list-group-item">
                                    {{r.response}}
                                    <span class="response_score">{{r.score}}%</span>
                                </li> <br>
                            {% endfor %}
                        </ul>    
                      {% endif %}
                    {% endif %}
                  </div>
                </div>
              </div>
            {% endif %}  
          {% endfor %}
        </div>
      </div>
  
      <div id="graph" class="tab-pane fade content-graph">
        <div id="chart-download-container">
            <button type="button" class="btn btn-primary download_graph-btn" id="download_graph-btn">
                Download graph &nbsp;<i class="fa fa-download download-fa" aria-hidden="true"></i>
            </button>
        </div>  
        <div id="chart_div" class="graph-container"></div>
      </div>
    </div>
  </div>


{% endblock %}
